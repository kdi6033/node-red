# node-red

## 5.6.12 Node-RED WebSocket 노드레드에서 웹소켙 사용하기    
[유튜브보기](https://youtu.be/Qob1-N8fe3w)   
node-red 에서 UI로 html을 사용할 때 node-red와 html 사이에 WebSocket 방식으로 통신을 하여 실시간으로 업데이트 되는 홈페이지 작성법을 설명한다.    
소스프로그램     
```
[{"id":"fd6546df.632a18","type":"inject","z":"4d7f7afa.615144","name":"Tick every 5 secs","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"5","crontab":"","once":false,"onceDelay":"","topic":"test","payload":"","payloadType":"date","x":170,"y":180,"wires":[["6525495f.1eecd8"]]},{"id":"370263af.e0203c","type":"websocket out","z":"4d7f7afa.615144","name":"","server":"985ecbc7.67a138","client":"","x":560,"y":180,"wires":[]},{"id":"6525495f.1eecd8","type":"function","z":"4d7f7afa.615144","name":"format time nicely","func":"msg.payload = Date(msg.payload).toString();\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":180,"wires":[["370263af.e0203c"]]},{"id":"734ecc43.6050a4","type":"websocket in","z":"4d7f7afa.615144","name":"","server":"985ecbc7.67a138","client":"","x":360,"y":280,"wires":[["340e1c45.9716c4"]]},{"id":"340e1c45.9716c4","type":"debug","z":"4d7f7afa.615144","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":570,"y":280,"wires":[]},{"id":"286f978b.ef2a18","type":"comment","z":"4d7f7afa.615144","name":"https://flows.nodered.org/flow/8666510f94ad422e4765","info":"","x":420,"y":60,"wires":[]},{"id":"9b1de891.a8df68","type":"comment","z":"4d7f7afa.615144","name":"웹소켙","info":"","x":150,"y":60,"wires":[]},{"id":"80d75e74.6d99a","type":"inject","z":"4d7f7afa.615144","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"테스트","payloadType":"str","x":370,"y":220,"wires":[["370263af.e0203c"]]},{"id":"68eef96b.216138","type":"template","z":"4d7f7afa.615144","name":"Simple Web Page","field":"payload.scriptSocket","fieldType":"msg","format":"html","syntax":"mustache","template":"        var ws;\n        var wsUri = \"ws:\";\n        var loc = window.location;\n        console.log(loc);\n        if (loc.protocol === \"https:\") { wsUri = \"wss:\"; }\n        // This needs to point to the web socket in the Node-RED flow\n        // ... in this case it's ws/simple\n        wsUri += \"//\" + loc.host + loc.pathname.replace(\"simple\",\"ws/simple\");\n\n        function wsConnect() {\n            console.log(\"connect\",wsUri);\n            ws = new WebSocket(wsUri);\n            //var line = \"\";    // either uncomment this for a building list of messages\n            ws.onmessage = function(msg) {\n                var line = \"\";  // or uncomment this to overwrite the existing message\n                // parse the incoming message as a JSON object\n                var data = msg.data;\n                console.log(data);\n                // build the output from the topic and payload parts of the object\n                line += \"<p>\"+data+\"</p>\";\n                // replace the messages div with the new \"line\"\n                document.getElementById('messages').innerHTML = line;\n                //ws.send(JSON.stringify({data:data}));\n            }\n            ws.onopen = function() {\n                // update the status div with the connection status\n                document.getElementById('status').innerHTML = \"connected\";\n                //ws.send(\"Open for data\");\n                console.log(\"connected\");\n            }\n            ws.onclose = function() {\n                // update the status div with the connection status\n                document.getElementById('status').innerHTML = \"not connected\";\n                // in case of lost connection tries to reconnect every 3 secs\n                setTimeout(wsConnect,3000);\n            }\n        }\n        \n        function doit(m) {\n            if (ws) { ws.send(m); }\n        }","x":350,"y":120,"wires":[["2ee6d3d5.235dec"]]},{"id":"2ee6d3d5.235dec","type":"template","z":"4d7f7afa.615144","name":"Main html","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE HTML>\n<html>\n<head>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n    <script type=\"text/javascript\"> {{{payload.scriptSocket}}} </script>\n</head>\n    <body onload=\"wsConnect();\" onunload=\"ws.disconnect();\">\n        <h1>웹소켙</h1>\n        <div id=\"messages\"></div>\n        <div id=\"status\">unknown</div>\n        <hr/>\n        <button type=\"button\" onclick='doit(\"누름\");'>Click to send message</button>\n    </body>\n</html>\n\n","x":520,"y":120,"wires":[["42a28745.bd5d78"]]},{"id":"42a28745.bd5d78","type":"http response","z":"4d7f7afa.615144","name":"","x":650,"y":120,"wires":[]},{"id":"1787be40.e87842","type":"http in","z":"4d7f7afa.615144","name":"","url":"/simple","method":"get","swaggerDoc":"","x":161,"y":120,"wires":[["68eef96b.216138"]]},{"id":"985ecbc7.67a138","type":"websocket-listener","z":"4d7f7afa.615144","path":"/ws/simple","wholemsg":"false"}]
```
## 5.6.13 노드레드 콘트롤용 웹소켙 사용하기    
[유튜브보기](https://youtu.be/F8ubWY85JRc)   
led 버튼을 만들어 기계제어를 할 때 사용할 수 있는 WebSocket 프로그램을 설명한다.     
소스프로그램   
```
[{"id":"370263af.e0203c","type":"websocket out","z":"4d7f7afa.615144","name":"","server":"985ecbc7.67a138","client":"","x":560,"y":220,"wires":[]},{"id":"734ecc43.6050a4","type":"websocket in","z":"4d7f7afa.615144","name":"","server":"985ecbc7.67a138","client":"","x":180,"y":320,"wires":[["85451a55.60aa68"]]},{"id":"340e1c45.9716c4","type":"debug","z":"4d7f7afa.615144","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":470,"y":320,"wires":[]},{"id":"9b1de891.a8df68","type":"comment","z":"4d7f7afa.615144","name":"웹소켙","info":"","x":150,"y":60,"wires":[]},{"id":"80d75e74.6d99a","type":"inject","z":"4d7f7afa.615144","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"in0\":0}","payloadType":"str","x":390,"y":220,"wires":[["370263af.e0203c"]]},{"id":"68eef96b.216138","type":"template","z":"4d7f7afa.615144","name":"Simple Web Page","field":"payload.scriptSocket","fieldType":"msg","format":"html","syntax":"mustache","template":"        var ws;\n        var wsUri = \"ws:\";\n        var loc = window.location;\n        console.log(loc);\n        if (loc.protocol === \"https:\") { wsUri = \"wss:\"; }\n        // This needs to point to the web socket in the Node-RED flow\n        // ... in this case it's ws/simple\n        wsUri += \"//\" + loc.host + loc.pathname.replace(\"simple\",\"ws/simple\");\n\n        function wsConnect() {\n            console.log(\"connect\",wsUri);\n            ws = new WebSocket(wsUri);\n            ws.onmessage = function(msg) {\n                // parse the incoming message as a JSON object\n                var data = JSON.parse(msg.data);\n                console.log(data);\n                if(data.in0=='1') \n                    document.getElementById('in0').innerHTML = \"<button class='button button-ledon' ></button>\";\n                else\n                    document.getElementById('in0').innerHTML = \"<button class='button button-ledoff' ></button>\";\n                    \n                //ws.send(JSON.stringify({data:data}));\n            }\n            ws.onopen = function() {\n                // update the status div with the connection status\n                document.getElementById('status').innerHTML = \"connected\";\n                //ws.send(\"Open for data\");\n                console.log(\"connected\");\n            }\n            ws.onclose = function() {\n                // update the status div with the connection status\n                document.getElementById('status').innerHTML = \"not connected\";\n                // in case of lost connection tries to reconnect every 3 secs\n                setTimeout(wsConnect,3000);\n            }\n        }\n        \n        function doit(m) {\n            if (ws) { ws.send(m); }\n        }","x":472,"y":120,"wires":[["2ee6d3d5.235dec"]]},{"id":"2ee6d3d5.235dec","type":"template","z":"4d7f7afa.615144","name":"Main html","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE HTML>\n<html>\n<head>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n    <style> {{{payload.style}}} </style>\n    <script type=\"text/javascript\"> {{{payload.scriptSocket}}} </script>\n</head>\n    <body onload=\"wsConnect();\" onunload=\"ws.disconnect();\">\n        <h1>웹소켙</h1>\n        <div id=\"status\">unknown</div>\n        입력표시\n        <div id=\"in0\"></div>\n        <hr/>\n        출력스위치<br>\n        <button class='button button-on' onclick='doit(\"{\\\"out0\\\":1}\");'></button>\n        <button class='button button-off' onclick='doit(\"{\\\"out0\\\":0}\");'></button>\n    </body>\n</html>\n\n","x":642,"y":120,"wires":[["42a28745.bd5d78"]]},{"id":"42a28745.bd5d78","type":"http response","z":"4d7f7afa.615144","name":"","x":772,"y":120,"wires":[]},{"id":"1787be40.e87842","type":"http in","z":"4d7f7afa.615144","name":"","url":"/simple","method":"get","swaggerDoc":"","x":161,"y":120,"wires":[["e707cffaac315b1b","ceeed98b.29b388"]]},{"id":"e707cffaac315b1b","type":"template","z":"4d7f7afa.615144","name":"style","field":"payload.style","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"body {\n    background: #eab0dc;\n    font-family: Arial, Helvetica, sans-serif;\n}\ntable, th, td {\n    padding: 2px;\n    border-collapse: collapse;\n    border: 1px solid #dddddd;\n    text-align: center;\n    vertical-align: middle;\n}\n\n\n/* Full-width input fields */\ninput[type=text], input[type=password] {\n  width: 150px;\n  padding: 5px 10px;\n  margin: 8px 0;\n  display: inline-block;\n  border: 1px solid #ccc;\n  box-sizing: border-box;\n}\n\n/* Set a style for all buttons */\nbutton {\n  background-color: #4CAF50; /*Green*/\n  color: white;\n  padding: 14px 20px;\n  margin: 8px 0;\n  border: none;\n  cursor: pointer;\n}\n\n.buttonMenu {\n          padding: 5px 24px;\n          margin-left:20%;\n          background-color:black;\n          border: none;\n          border-color:black;\n          color:white;\n          text-align: left;\n          text-decoration: none;\n          display: inline-block;\n          font-size: 16px;\n          margin: 4px 2px;\n          cursor: pointer;\n        }\n        .sidenav {\n          height: 100%;\n          width: 0;\n          position: fixed;\n          z-index: 1;\n          top: 0;\n          left: 0;\n          background-color: #111;\n          overflow-x: hidden;\n          transition: 0.5s;\n          padding-top: 60px;\n        }\n        .sidenav a {\n          padding: 8px 8px 8px 32px;\n          text-decoration: none;\n          font-size: 18px;\n          color: #818181;\n          display: block;\n                transition: 0.3s;\n        }\n        .sidenav a:hover {\n          color: #f1f1f1;\n        }\n        .sidenav .closebtn {\n          position: absolute;\n          top: 0;\n          right: 25px;\n          font-size: 36px;\n          margin-left: 50px;\n        }\n\n.buttonM {background-color: #ff66cc;color:white; width:100px; height:20px; padding: 0px 0px; font-size: 16px} /* 기기선택 */  \n.buttonL {background-color: #ff66cc;color:white; width:100px; height:25px; padding: 0px 0px; font-size: 16px} /* 선택 */  \n.buttonMenu {background-color: #000000;} \n.button2 {background-color: #008CBA;} /* Blue */\n.button3 {background-color: #f44336;} /* Red */ \n.button4 {background-color: #e7e7e7; color: black;} /* Gray */ \n.button5 {background-color: #555555;} /* Black */\n.button20 {width: 20%;} \n.button-on {border-radius: 100%; padding: 20px; font-size: 18px; margin: 0px 0px; background-color: #4CAF50;}\n.button-off {border-radius: 100%; padding: 20px; font-size: 18px; background-color: #707070;}\n.button-ledon {border-radius: 100%; padding: 10px; font-size: 8px; margin: 0px 0px; background-color: #ff4500;}\n.button-ledoff {border-radius: 100%; padding: 10px; font-size: 8px; background-color: #707070;}\n\nbutton:hover {\n  opacity: 0.8;\n}\n\n/* Extra styles for the cancel button */\n.cancelbtn {\n  width: auto;\n  padding: 10px 18px;\n  background-color: #f44336;\n}\n\n/* Center the image and position the close button */\n.imgcontainer {\n  text-align: center;\n  margin: 24px 0 12px 0;\n  position: relative;\n}\n\nimg.avatar {\n  width: 40%;\n  border-radius: 50%;\n}\n\n.container {\n  padding: 16px;\n}\n\nspan.psw {\n  float: right;\n  padding-top: 16px;\n}\n\n/* The Modal (background) */\n.modal {\n  display: none; /* Hidden by default */\n  position: fixed; /* Stay in place */\n  z-index: 1; /* Sit on top */\n  left: 0;\n  top: 0;\n  width: 100%; /* Full width */\n  height: 100%; /* Full height */\n  overflow: auto; /* Enable scroll if needed */\n  background-color: rgb(0,0,0); /* Fallback color */\n  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */\n  padding-top: 60px;\n}\n\n/* Modal Content/Box */\n.modal-content {\n  background-color: #fefefe;\n  margin: 5% auto 15% auto; /* 5% from the top, 15% from the bottom and centered */\n  border: 1px solid #888;\n  width: 80%; /* Could be more or less, depending on screen size */\n}\n\n/* The Close Button (x) */\n.close {\n  position: absolute;\n  right: 25px;\n  top: 0;\n  color: #000;\n  font-size: 35px;\n  font-weight: bold;\n}\n\n.close:hover,\n.close:focus {\n  color: red;\n  cursor: pointer;\n}\n\n/* Add Zoom Animation */\n.animate {\n  -webkit-animation: animatezoom 0.6s;\n  animation: animatezoom 0.6s\n}\n\n@-webkit-keyframes animatezoom {\n  from {-webkit-transform: scale(0)} \n  to {-webkit-transform: scale(1)}\n}\n  \n@keyframes animatezoom {\n  from {transform: scale(0)} \n  to {transform: scale(1)}\n}\n\n/* Change styles for span and cancel button on extra small screens */\n@media screen and (max-width: 300px) {\n  span.psw {\n     display: block;\n     float: none;\n  }\n  .cancelbtn {\n     width: 100%;\n  }\n}","x":310,"y":120,"wires":[["68eef96b.216138"]]},{"id":"a4db95eb.0ccc88","type":"inject","z":"4d7f7afa.615144","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"in0\":1}","payloadType":"str","x":390,"y":260,"wires":[["370263af.e0203c"]]},{"id":"85451a55.60aa68","type":"json","z":"4d7f7afa.615144","name":"","property":"payload","action":"","pretty":false,"x":330,"y":320,"wires":[["340e1c45.9716c4"]]},{"id":"c4d59526.e28758","type":"function","z":"4d7f7afa.615144","name":"","func":"msg.payload=\"{\\\"in0\\\":0}\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":180,"wires":[["370263af.e0203c"]]},{"id":"ceeed98b.29b388","type":"delay","z":"4d7f7afa.615144","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":200,"y":180,"wires":[["c4d59526.e28758"]]},{"id":"985ecbc7.67a138","type":"websocket-listener","z":"4d7f7afa.615144","path":"/ws/simple","wholemsg":"false"}]
```
